<!doctype html>
<html lang="fr"><head>
<meta charset="utf-8" /><meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Photo fin de match — Sporting Villette</title>
<meta name="color-scheme" content="light dark" />
<link rel="stylesheet" href="https://sportingvillette-beep.github.io/form-score-club/assets/styles.css?v=2">
</head><body>
<div class="wrap"><div class="card">
  <header>
    <img alt="Logo du club" src="/form-score-club/assets/logo.png" onerror="this.style.display='none'">
    <div><div class="club">Photo fin de match</div><div class="hint">Réservé aux matchs terminés</div></div>
    <a class="mini" style="margin-left:auto" href="https://sportingvillette-beep.github.io/form-score-club/index.html">Accueil</a>
  </header>

  <div class="selected" id="selBox" hidden>
    <div>
      <div class="sel-teams" id="selTeams"></div>
      <div class="muted" id="selMeta"></div>
    </div>
  </div>

  <p id="infoFinale" class="muted"></p>

  <form id="fPhoto">
    <h3>Ajouter une photo</h3>
    <div class="dropzone" id="dz2">
      <div class="dz-title">Image</div>
      <input type="file" name="photo_finale" id="photo2" accept="image/*"><img id="preview2" alt="Aperçu photo" />
    </div>
    <div class="actions"><button type="submit" id="btn2">Envoyer photo</button><div class="msg muted" id="msg2"></div></div>
  </form>

  <footer class="muted">Après envoi, retour automatique à l’accueil.</footer>
</div></div>

<script>
const CONFIG={ webhookPhotoUrl:'https://hook.eu2.make.com/40xiygzru2pfcgwooofj7ewouwqqddsi', maxSizeMB:10 };
const U={fmtDate:d=>d?d.toLocaleDateString('fr-FR',{weekday:'long',day:'2-digit',month:'long'}):'',fmtTime:d=>d?d.toLocaleTimeString('fr-FR',{hour:'2-digit',minute:'2-digit'}):''};
function getSelection(){ try{ return JSON.parse(sessionStorage.getItem('selectedMatch')||'null'); }catch{return null;} }
function isFinished(w){return /(victoire|defaite|défaite|match\s*nul|termine|terminé)/i.test(String(w||''));}
function requireSelection(){ const sel=getSelection(); if(!sel){ location.href='https://sportingvillette-beep.github.io/form-score-club/index.html?selectfirst=1'; return null;} return sel;}

(function init(){
  const sel=requireSelection(); if(!sel) return;
  sel._date=new Date(sel._date);
  selTeams.textContent=`${sel.equipe1} vs ${sel.equipe2}`;
  selMeta.textContent=[U.fmtDate(sel._date),U.fmtTime(sel._date),sel.categorie,sel.championnat,sel.ville].filter(Boolean).join(' · ');
  selBox.hidden=false;
  infoFinale.textContent = isFinished(sel.winlose)? 'Match terminé ✅ — vous pouvez ajouter une photo finale.' : '⚠️ Réservé aux matchs terminés.';
})();

// dropzone + submit
['dragenter','dragover'].forEach(evt=>dz2.addEventListener(evt,e=>{e.preventDefault();e.stopPropagation();dz2.classList.add('drag')}));
['dragleave','drop'].forEach(evt=>dz2.addEventListener(evt,e=>{e.preventDefault();e.stopPropagation();dz2.classList.remove('drag')}));
dz2.addEventListener('drop',e=>{ if(e.dataTransfer.files?.length){ photo2.files=e.dataTransfer.files; photo2.dispatchEvent(new Event('change')); } });
photo2.addEventListener('change',()=>{ const f=photo2.files[0]; if(!f){ preview2.style.display='none'; preview2.src=''; return; } preview2.src=URL.createObjectURL(f); preview2.style.display='block'; });

fPhoto.addEventListener('submit', async (e)=>{
  e.preventDefault();
  const sel=getSelection(); const f=photo2.files[0];
  if(!f){ msg2.textContent='Choisissez une photo.'; msg2.className='msg err'; return; }
  if (f && f.size>CONFIG.maxSizeMB*1024*1024){ msg2.textContent=`Fichier trop lourd (max ${CONFIG.maxSizeMB} Mo).`; msg2.className='msg err'; return; }
  const fd=new FormData();
  fd.append('match_id', sel?.match_id||''); fd.append('equipe1_label', sel?.equipe1||''); fd.append('equipe2_label', sel?.equipe2||'');
  fd.append('meta', [U.fmtDate(new Date(sel?._date)), U.fmtTime(new Date(sel?._date)), sel?.categorie, sel?.ville].filter(Boolean).join(' · '));
  fd.append('photo_finale', f);
  try{
    btn2.disabled=true; btn2.textContent='Envoi…'; msg2.textContent='Transmission…'; msg2.className='msg muted';
    const res=await fetch(CONFIG.webhookPhotoUrl,{method:'POST', body:fd}); if(!res.ok) throw 0;
    msg2.textContent='Photo envoyée pour archivage !'; msg2.className='msg ok';
    setTimeout(()=>location.href='https://sportingvillette-beep.github.io/form-score-club/index.html#ok',600);
  }catch{ msg2.textContent='Erreur d’envoi.'; msg2.className='msg err'; }
  finally{ btn2.disabled=false; btn2.textContent='Envoyer photo'; }
});
</script>
</body></html>
