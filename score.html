<!doctype html>
<html lang="fr"><head>
<meta charset="utf-8" /><meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Ajouter score — Sporting Villette</title>
<meta name="color-scheme" content="light dark" />
<link rel="stylesheet" href="https://sportingvillette-beep.github.io/form-score-club/assets/styles.css?v=2">
</head><body>
<div class="wrap"><div class="card">
  <header>
    <img alt="Logo du club" src="/form-score-club/assets/logo.png" onerror="this.style.display='none'">
    <div><div class="club">Ajouter score en direct</div><div class="hint">Match choisi à l’étape précédente</div></div>
    <a class="mini" style="margin-left:auto" href="https://sportingvillette-beep.github.io/form-score-club/index.html">Accueil</a>
  </header>

  <!-- plus de sélection/liste ici -->
  <div class="selected" id="selBox" hidden>
    <div>
      <div class="sel-teams" id="selTeams"></div>
      <div class="muted" id="selMeta"></div>
    </div>
  </div>

  <form id="f" novalidate>
    <input type="hidden" name="match_id" id="match_id">
    <label>État du match
      <select name="etat_match" id="etat_match" required>
        <option value="termine" selected>Terminé</option>
        <option value="en_cours">En cours</option>
      </select>
      <span class="muted">Si « En cours », indiquez le temps de jeu.</span>
    </label>
    <div class="row">
      <label><span id="label_dom">Score domicile</span>
        <input type="number" name="score_dom" id="score_dom" inputmode="numeric" min="0" max="200" required>
      </label>
      <label><span id="label_ext">Score extérieur</span>
        <input type="number" name="score_ext" id="score_ext" inputmode="numeric" min="0" max="200" required>
      </label>
    </div>
    <div class="row one" id="temps_wrapper" hidden>
      <label>Temps de jeu (minutes)
        <input type="number" name="temps_jeu" id="temps_jeu" inputmode="numeric" min="1" max="90" placeholder="ex : 20">
      </label>
    </div>
    <label>Résultat (auto)
      <select name="statut" id="statut" required style="pointer-events:none;opacity:.95">
        <option value="" disabled selected>— Calculé automatiquement —</option>
        <option>En cours</option><option>Victoire</option><option>Défaite</option><option>Match Nul</option><option>Terminé</option>
      </select>
    </label>
    <div class="dropzone" id="dz"><div class="dz-title">Photo (facultatif)</div>
      <input type="file" name="photo" id="photo" accept="image/*"><img id="preview" alt="Aperçu photo" />
    </div>
    <div class="actions"><button type="submit" id="btn">Envoyer score</button><div class="msg muted" id="msg"></div></div>
  </form>

  <footer class="muted">Après envoi, retour automatique à l’accueil.</footer>
</div></div>

<script>
const CONFIG = {
  webhookScoreUrl:'https://hook.eu2.make.com/12s2f2licqusjj1xiw3p3tulrfnd5dgw',
  clubAliases:['Sporting Villette','Villette Genas','Entente Villette Genas','Est Lyonnais','Lyon Est Handball'],
  maxSizeMB:10
};
const U={fmtDate:d=>d?d.toLocaleDateString('fr-FR',{weekday:'long',day:'2-digit',month:'long'}):'',fmtTime:d=>d?d.toLocaleTimeString('fr-FR',{hour:'2-digit',minute:'2-digit'}):''};
function getSelection(){ try{ return JSON.parse(sessionStorage.getItem('selectedMatch')||'null'); }catch{return null;} }
function isFinished(w){return /(victoire|defaite|défaite|match\s*nul|termine|terminé)/i.test(String(w||''));}

function requireSelection(){
  const sel=getSelection();
  if(!sel){ location.href='https://sportingvillette-beep.github.io/form-score-club/index.html?selectfirst=1'; return null; }
  return sel;
}

(function init(){
  const sel=requireSelection(); if(!sel) return;
  document.getElementById('selTeams').textContent=`${sel.equipe1} vs ${sel.equipe2}`;
  document.getElementById('selMeta').textContent=[U.fmtDate(new Date(sel._date)),U.fmtTime(new Date(sel._date)),sel.categorie,sel.championnat,sel.ville].filter(Boolean).join(' · ');
  document.getElementById('selBox').hidden=false;

  document.getElementById('match_id').value=sel.match_id;
  document.getElementById('label_dom').textContent='Score '+sel.equipe1;
  document.getElementById('label_ext').textContent='Score '+sel.equipe2;
  document.getElementById('etat_match').value=isFinished(sel.winlose)?'termine':'en_cours';
  toggleTempsByEtat();
})();

const etatEl=etat_match, tempsWrap=temps_wrapper, tempsEl=temps_jeu, sdEl=score_dom, seEl=score_ext, statutEl=statut;
function computeResult(){
  if(etatEl.value==='en_cours'){ statutEl.value='En cours'; return; }
  const s1=parseInt(sdEl.value,10), s2=parseInt(seEl.value,10);
  if(Number.isNaN(s1)||Number.isNaN(s2)){ statutEl.value=''; return; }
  if(s1===s2){ statutEl.value='Match Nul'; return; }
  const CL=['sporting villette','villette genas','entente villette genas','est lyonnais','lyon est handball'];
  const eq1=(label_dom.textContent||'').replace(/^Score\s+/,'').toLowerCase();
  const eq2=(label_ext.textContent||'').replace(/^Score\s+/,'').toLowerCase();
  const isClub1=CL.some(a=>eq1.includes(a)), isClub2=CL.some(a=>eq2.includes(a));
  statutEl.value = s1>s2 ? (isClub1?'Victoire':isClub2?'Défaite':'Terminé')
                         : (isClub2?'Victoire':isClub1?'Défaite':'Terminé');
}
function toggleTempsByEtat(){ const enCours=etatEl.value==='en_cours'; tempsWrap.hidden=!enCours; if(!enCours) tempsEl.value=''; computeResult(); }
etatEl.addEventListener('change',toggleTempsByEtat); sdEl.addEventListener('input',computeResult); seEl.addEventListener('input',computeResult);
tempsEl.addEventListener('input',()=>{ if((tempsEl.value||'').trim()!==''){ etatEl.value='en_cours'; toggleTempsByEtat(); }});

// dropzone
const dz=dz, file=photo, prev=preview;
['dragenter','dragover'].forEach(evt=>dz.addEventListener(evt,e=>{e.preventDefault();e.stopPropagation();dz.classList.add('drag')}));
['dragleave','drop'].forEach(evt=>dz.addEventListener(evt,e=>{e.preventDefault();e.stopPropagation();dz.classList.remove('drag')}));
dz.addEventListener('drop',e=>{ if(e.dataTransfer.files?.length){ file.files=e.dataTransfer.files; file.dispatchEvent(new Event('change')); } });
photo.addEventListener('change',()=>{ const f=photo.files[0]; if(!f){ prev.style.display='none'; prev.src=''; return; } prev.src=URL.createObjectURL(f); prev.style.display='block'; });

f.addEventListener('submit', async (e)=>{
  e.preventDefault(); const msg=msg, btn=btn;
  const id=match_id.value.trim(); if(!id){ msg.textContent='ID manquant.'; msg.className='msg err'; return; }
  if(score_dom.value===''||score_ext.value===''){ msg.textContent='Renseignez les scores.'; msg.className='msg err'; return; }
  const f=photo.files[0]; if(f && f.size>CONFIG.maxSizeMB*1024*1024){ msg.textContent=`Fichier trop lourd (max ${CONFIG.maxSizeMB} Mo).`; msg.className='msg err'; return; }
  const fd=new FormData(e.target);
  if(etatEl.value==='en_cours'){ const t=(temps_jeu.value||'').trim(); if(!t){ msg.textContent='Indiquez le temps de jeu.'; msg.className='msg err'; return; } fd.set('WinLose', `${parseInt(t,10)}e`); }
  else { computeResult(); fd.set('WinLose', statut.value||'Terminé'); }
  const sel=getSelection(); if(sel){ fd.append('equipe1_label', sel.equipe1||''); fd.append('equipe2_label', sel.equipe2||''); }
  try{ btn.disabled=true; btn.textContent='Envoi…'; msg.textContent='Transmission…'; msg.className='msg muted';
       const res=await fetch(CONFIG.webhookScoreUrl,{method:'POST',body:fd}); if(!res.ok) throw 0;
       msg.textContent='Score envoyé !'; msg.className='msg ok';
       setTimeout(()=>location.href='https://sportingvillette-beep.github.io/form-score-club/index.html#ok',600);
  }catch{ msg.textContent='Erreur d’envoi.'; msg.className='msg err'; }
  finally{ btn.disabled=false; btn.textContent='Envoyer score'; }
});
</script>
</body></html>
