<!doctype html>
<html lang="fr">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Club — Saisie score & photo</title>
  <meta name="color-scheme" content="light dark" />
  <style>
    :root{
      /* ==== Palette club (accessibilité clair/sombre) ==== */
      --brand: #b9314f;        /* primaire */
      --brand-2: #d9a05b;      /* secondaire/accent */
      --bg: #f7f5f5;           /* fond clair */
      --text: #2c2c2c;         /* texte en clair */
      --muted: #64748b;
      --ok: #2da160;           /* vert succès (clair) */
      --err: #b00020;
      --card: #ffffff;
      --border: #e5e7eb;
      --input-bg: #ffffff;     /* champs en clair */
    }
    @media (prefers-color-scheme: dark){
      :root{ 
        --bg:#2c2c2c;          /* fond sombre */
        --text:#f7f5f5;        /* texte en sombre */
        --card:#232323;
        --border:#3a3a3a;
        --input-bg:#171717;    /* champs en sombre */
        --ok:#74d59f;          /* vert succès (sombre) */
      }
    }
    }
    @media (prefers-color-scheme: dark){
      :root{ --bg:#0b1220; --text:#e5e7eb; --card:#0f172a; --border:#1f2937; }
    }
    html,body{
      margin:0; font-family: system-ui, -apple-system, Segoe UI, Roboto, Ubuntu, Cantarell, Noto Sans, sans-serif;
      background: var(--bg);
      color:var(--text);
    }
    body{
      margin:0; font-family: system-ui, -apple-system, Segoe UI, Roboto, Ubuntu, Cantarell, Noto Sans, sans-serif;
      background: radial-gradient(1200px 600px at 80% -10%, rgba(14,165,233,.15), transparent 50%),
                  radial-gradient(800px 400px at -10% 110%, rgba(3,105,161,.12), transparent 40%), var(--bg);
      color:var(--text);
    }
    .wrap{max-width:640px;margin:28px auto;padding:0 16px}
    .card{background:var(--card);border:1px solid var(--border);border-radius:18px;box-shadow:0 10px 30px rgba(2,6,23,.08);padding:22px}
    header{display:flex;align-items:center;gap:14px;margin-bottom:12px}
    header img{width:44px;height:44px;border-radius:10px;object-fit:cover;border:1px solid var(--border)}
    header .club{font-weight:700;letter-spacing:.2px}
    header .hint{font-size:12px;color:var(--muted)}

    form{display:grid;gap:12px}
    label{display:grid;gap:6px;font-size:14px}
    input, select, button{font-size:16px;padding:12px 14px;border:1px solid var(--border);border-radius:12px;background:var(--input-bg);color:var(--text)}
    input::placeholder{color:var(--muted)}
    input[type="file"]{padding:10px}
    .row{display:grid;grid-template-columns:1fr 1fr;gap:12px}
    .muted{color:var(--muted);font-size:12px}
    .actions{display:flex;gap:10px;align-items:center}
    button{cursor:pointer;background:linear-gradient(135deg,var(--brand),var(--brand-2));color:#fff;border:none;font-weight:600}
    button[disabled]{opacity:.6;cursor:progress}
    button[disabled]{opacity:.6;cursor:progress}

    .dropzone{border:2px dashed var(--border);border-radius:14px;padding:14px;text-align:center;background:rgba(185,49,79,.06)}
    .dropzone.drag{border-color:var(--brand);background:rgba(185,49,79,.12)}
    #preview{max-width:100%;max-height:220px;border-radius:12px;display:none;margin-top:8px;border:1px solid var(--border)}

    .msg{min-height:20px}
    .ok{color:var(--ok)}
    .err{color:var(--err)}
    footer{margin-top:18px;text-align:center}
    /* Liste de matchs (mobile-first) */
    .matches .list{display:grid;gap:10px;margin-bottom:10px}
    .match-card{display:flex;justify-content:space-between;align-items:center;gap:8px;padding:12px 14px;border:1px solid var(--border);border-radius:14px;background:var(--card);cursor:pointer}
    .match-card:active{transform:scale(.99)}
    .mc-left{display:grid;gap:4px;text-align:left}
    .mc-title{font-weight:700}
    .mc-sub{font-size:12px;color:var(--muted)}
    .selected{display:flex;justify-content:space-between;align-items:center;gap:10px;margin:10px 0 6px;padding:10px 12px;border:1px dashed var(--border);border-radius:12px;background:rgba(185,49,79,.06)}
    .sel-teams{font-weight:700}
    .mini{padding:8px 10px;border-radius:10px;background:linear-gradient(135deg,var(--brand),var(--brand-2));color:#fff;border:none}
  </style>
</head>
<body>
  <div class="wrap">
    <div class="card">
      <header>
        <img id="clubLogo" alt="Logo du club" src="logo.png" onerror="this.style.display='none'" />
        <div>
          <div class="club" id="clubName">Sporting Villette</div>
          <div class="hint">Saisie du score & photo — week-end</div>
        </div>
      </header>

      <!-- Sélecteur de rencontre -->
      <section id="picker" class="matches">
        <h3>Choisir une rencontre</h3>
        <div id="matchesMsg" class="muted">Chargement des matchs…</div>
        <div id="matchesList" class="list" aria-live="polite"></div>
      </section>

      <!-- Détail de la rencontre sélectionnée -->
      <div id="selected" class="selected" hidden>
        <div class="sel-top">
          <div class="sel-teams" id="selTeams"></div>
          <div class="muted" id="selMeta"></div>
        </div>
        <button type="button" id="changeBtn" class="mini">Changer</button>
      </div>

      <form id="f" novalidate>
        <label id="idLine">ID match
          <input name="match_id" id="match_id" required placeholder="ex: MCH-2025-08-12-001" autocomplete="off">
        </label>
        <div class="row">
          <label><span id="label_dom">Score domicile</span>
            <input type="number" name="score_dom" id="score_dom" inputmode="numeric" min="0" max="200" required>
          </label>
          <label><span id="label_ext">Score extérieur</span>
            <input type="number" name="score_ext" id="score_ext" inputmode="numeric" min="0" max="200" required>
          </label>
        </div>
        <label>Résultat
          <select name="statut" id="statut" required>
            <option value="" disabled selected>— Choisir —</option>
            <option>Terminé</option>
            <option>Gagné</option>
            <option>Perdu</option>
            <option>À jouer</option>
          </select>
        </label>

        <div class="dropzone" id="dz">
          <label>Photo du match (facultatif)
            <input type="file" name="photo" id="photo" accept="image/*">
          </label>
          <div class="muted">Vous pouvez glisser-déposer une image ici, ou utiliser l'appareil photo.</div>
          <img id="preview" alt="Aperçu photo" />
        </div>

        <!-- Anti-spam très simple (vérifier côté Make) -->
        <input type="hidden" name="form_secret" id="form_secret" value="CHANGE-MOI">

        <div class="actions">
          <button type="submit" id="btn">Envoyer</button>
          <div class="msg muted" id="msg" role="status" aria-live="polite"></div>
        </div>
      </form>

      <footer class="muted">Astuce : générez un QR code avec l'URL <code>?match_id=...</code> pour préremplir automatiquement.</footer>
    </div>
  </div>

  <script>
    // ======== PARAMÈTRES À PERSONNALISER ========
    const CONFIG = {
      clubName: 'Sporting Villette',
      logoUrl: 'logo.png', // Chemin relatif ou URL absolue (laisser vide pour masquer)
      webhookUrl: 'https://hook.eu2.make.com/12s2f2licqusjj1xiw3p3tulrfnd5dgw',
      maxSizeMB: 10,
      renameUploads: true, // renommer en <match_id>-<timestamp>.<ext>
      theme: { brand: '#b9314f', brand2: '#d9a05b' },
      // === Connexion Google Sheets (lecture publique via CSV publié) ===
      gsheetCsvUrl: 'https://docs.google.com/spreadsheets/d/e/2PACX-1vQvskuueB25qKj0hbDWjFPomFdhfWRduUsNLp6Kv-za4t4oXcbbLsLrNsjwIt0ZH7C9B75pYBGDJfQu/pub?gid=0&single=true&output=csv',
      fields: { match_id:'Code Gesthand', date:'Date', categorie:'Catégorie', championnat:'Championnat', equipe1:'Eq1', equipe2:'Eq2' },
      dateWindow: { pastDays: 5, futureDays: 2 },
      // Noms/alias de nos équipes pour l'auto-calcul du résultat
      clubAliases: ['Sporting Villette','Villette Genas','Est Lyonnais','Lyon Est Handball']
    };
    // ===========================================

    // Appliquer thème & identité
    (function initBrand(){
      if (CONFIG.theme?.brand) document.documentElement.style.setProperty('--brand', CONFIG.theme.brand);
      if (CONFIG.theme?.brand2) document.documentElement.style.setProperty('--brand-2', CONFIG.theme.brand2);
      if (CONFIG.clubName) document.getElementById('clubName').textContent = CONFIG.clubName;
      if (CONFIG.logoUrl){
        const img = document.getElementById('clubLogo');
        img.src = CONFIG.logoUrl;
      }
    })();

    // Préremplissage via paramètres d'URL (?match_id=...)
    (function prefill(){
      const p = new URLSearchParams(location.search);
      const id = p.get('match_id');
      if (id) document.getElementById('match_id').value = id;
    })();

    // Drag & drop pour la photo
    (function dropZone(){
      const dz = document.getElementById('dz');
      const file = document.getElementById('photo');
      const prev = document.getElementById('preview');
      ;['dragenter','dragover'].forEach(evt=>dz.addEventListener(evt, e=>{e.preventDefault();e.stopPropagation();dz.classList.add('drag')}));
      ;['dragleave','drop'].forEach(evt=>dz.addEventListener(evt, e=>{e.preventDefault();e.stopPropagation();dz.classList.remove('drag')}));
      dz.addEventListener('drop', (e)=>{ if(e.dataTransfer.files?.length){ file.files = e.dataTransfer.files; file.dispatchEvent(new Event('change')); } });
      file.addEventListener('change', ()=>{
        const f = file.files[0];
        if(!f){ prev.style.display='none'; prev.src=''; return; }
        prev.src = URL.createObjectURL(f); prev.style.display='block';
      });
    })();

    function extFrom(type, fallback){
      if(!type) return fallback || 'jpg';
      if (type === 'image/jpeg') return 'jpg';
      if (type === 'image/png')  return 'png';
      if (type === 'image/webp') return 'webp';
      if (type === 'image/heic' || type === 'image/heif') return 'heic';
      return fallback || 'jpg';
    }
    function slugify(s){ return String(s||'').trim().replace(/\s+/g,'-').replace(/[^\w\-]+/g,'').toUpperCase(); }

    const form = document.getElementById('f');
    const msg  = document.getElementById('msg');
    const btn  = document.getElementById('btn');

    form.addEventListener('submit', async (e)=>{
      e.preventDefault();
      msg.textContent = '';

      // Validations basiques
      const id = document.getElementById('match_id').value.trim();
      const sd = document.getElementById('score_dom').value;
      const se = document.getElementById('score_ext').value;
      const st = document.getElementById('statut').value;
      if(!id || sd==='' || se==='' || !st){ msg.textContent = 'Merci de compléter tous les champs requis.'; msg.className = 'msg err'; return; }

      // Poids du fichier
      const inputFile = document.getElementById('photo');
      const f = inputFile.files[0];
      if (f && f.size > CONFIG.maxSizeMB * 1024 * 1024){ msg.textContent = `Fichier trop lourd (max ${CONFIG.maxSizeMB} Mo).`; msg.className = 'msg err'; return; }

      // Renommer côté client
      if (f && CONFIG.renameUploads){
        const ext = extFrom(f.type, f.name.split('.').pop());
        const renamed = new File([f], `${slugify(id)}-${Date.now()}.${ext}`, { type: f.type || 'image/jpeg' });
        const dt = new DataTransfer(); dt.items.add(renamed); document.getElementById('photo').files = dt.files;
      }

      const fd = new FormData(form);

      try{
        btn.disabled = true; btn.textContent = 'Envoi…'; msg.textContent = 'Transmission sécurisée…'; msg.className = 'msg muted';
        const res = await fetch(CONFIG.webhookUrl, { method:'POST', body: fd });
        if(!res.ok) throw new Error('Webhook non joignable');
        form.reset();
        document.getElementById('preview').style.display='none';
        msg.textContent = 'Merci, c\'est envoyé !'; msg.className = 'msg ok';
      }catch(err){
        console.error(err);
        msg.textContent = 'Erreur d\'envoi. Vérifiez la connexion et réessayez.'; msg.className = 'msg err';
      }finally{
        btn.disabled = false; btn.textContent = 'Envoyer';
      }
    });
  /* === Sélecteur de rencontre (injection) === */
  (function(){
    const matchesMsg = document.getElementById('matchesMsg');
    if(!matchesMsg) return;
    const matchesList = document.getElementById('matchesList');
    const idLine = document.getElementById('idLine');
    const selectedBox = document.getElementById('selected');
    const selTeams = document.getElementById('selTeams');
    const selMeta = document.getElementById('selMeta');
    const changeBtn = document.getElementById('changeBtn');
    const labelDom = document.getElementById('label_dom');
    const labelExt = document.getElementById('label_ext');

    function setTeamLabels(eq1,eq2){ if(eq1) labelDom.textContent = 'Score ' + eq1; if(eq2) labelExt.textContent = 'Score ' + eq2; }
    function parseDate(val){ if(!val) return null; if(/\//.test(val)){ const p=val.split('/'); if(p.length===3){ return new Date(p[2]+'-'+p[1].padStart(2,'0')+'-'+p[0].padStart(2,'0')); } } const d=new Date(val); return isNaN(d)?null:d; }
    function fmtDate(d){ return d?d.toLocaleDateString('fr-FR',{weekday:'short',day:'2-digit',month:'short'}):''; }
    function inWindow(d){ const base=new Date(); base.setHours(0,0,0,0); const start=new Date(base); start.setDate(start.getDate()-(CONFIG.dateWindow?.pastDays||5)); const end=new Date(base); end.setDate(end.getDate()+(CONFIG.dateWindow?.futureDays||2)); return d>=start && d<=end; }

    function csvToRows(csv){ const rows=[]; let field='', row=[], i=0, inq=false; while(i<csv.length){ const c=csv[i++]; if(c==='"'){ if(inq && csv[i]==='"'){ field+='"'; i++; } else { inq=!inq; } } else if(c===',' && !inq){ row.push(field); field=''; } else if((c==='
'||c==='
') && !inq){ if(field!==''||row.length){ row.push(field); rows.push(row); row=[]; field=''; } } else { field+=c; } } if(field!==''||row.length){ row.push(field); rows.push(row); } return rows; }

    async function loadMatches(){ const url=CONFIG.gsheetCsvUrl; if(!url){ matchesMsg.textContent = "Configurez CONFIG.gsheetCsvUrl (CSV publié)."; return; } try{ matchesMsg.textContent='Chargement…'; const res=await fetch(url,{cache:'no-store'}); if(!res.ok) throw 0; const csv=await res.text(); const rows=csvToRows(csv); const headers=rows.shift().map(h=>h.trim().toLowerCase()); const map=Object.fromEntries(headers.map((h,i)=>[h,i])); const F=CONFIG.fields||{}; const L=Object.fromEntries(Object.entries(F).map(([k,v])=>[k,(v||'').toLowerCase()])); const items=rows.map(r=>({ match_id:r[map[L.match_id]], date:r[map[L.date]], categorie:r[map[L.categorie]], championnat:r[map[L.championnat]], equipe1:r[map[L.equipe1]], equipe2:r[map[L.equipe2]] })).filter(x=>x&&x.match_id); const enriched=items.map(x=>({...x,_date:parseDate(x.date)})).filter(x=>x._date && inWindow(x._date)); enriched.sort((a,b)=>a._date-b._date); renderMatches(enriched); }catch(e){ matchesMsg.textContent='Impossible de charger la liste des matchs.'; } }

    function renderMatches(list){ matchesList.innerHTML=''; if(!list.length){ matchesMsg.textContent='Aucun match dans la fenêtre sélectionnée.'; return; } matchesMsg.textContent=''; const frag=document.createDocumentFragment(); list.forEach(m=>{ const b=document.createElement('button'); b.type='button'; b.className='match-card'; b.innerHTML='<div class="mc-left"><div class="mc-title">'+(m.equipe1||'').trim()+' <span class="muted">vs</span> '+(m.equipe2||'').trim()+'</div><div class="mc-sub">'+fmtDate(m._date)+' · '+(m.categorie||'')+' · '+(m.championnat||'')+'</div></div><div class="mc-right muted">'+m.match_id+'</div>'; b.addEventListener('click',()=>selectMatch(m)); frag.appendChild(b); }); matchesList.appendChild(frag); }

    function selectMatch(m){ selTeams.textContent=(m.equipe1||'').trim()+' vs '+(m.equipe2||'').trim(); selMeta.textContent=fmtDate(m._date)+' · '+(m.categorie||'')+' · '+(m.championnat||''); selectedBox.hidden=false; idLine.style.display='none'; document.getElementById('match_id').value=m.match_id||''; setTeamLabels(m.equipe1,m.equipe2); document.getElementById('f').scrollIntoView({behavior:'smooth',block:'start'}); }

    changeBtn.addEventListener('click',()=>{ selectedBox.hidden=true; idLine.style.display=''; document.getElementById('match_id').value=''; setTeamLabels('domicile','extérieur'); });

    loadMatches();
  })();
  </script>
<script>
  // === Auto-calcul du résultat (Victoire/Défaite/Match Nul) ===
  (function(){
    var labelDom = document.getElementById('label_dom');
    var labelExt = document.getElementById('label_ext');
    var sdEl = document.getElementById('score_dom');
    var seEl = document.getElementById('score_ext');
    var statutEl = document.getElementById('statut');
    var CLUBS = (window.CONFIG && CONFIG.clubAliases ? CONFIG.clubAliases : []).map(function(s){ return String(s||'').toLowerCase(); });

    function teamNameFromLabel(el){ var t = (el && el.textContent) ? el.textContent : ''; return t.indexOf('Score ') === 0 ? t.slice(6) : t; }
    function compute(){
      var s1 = parseInt(sdEl.value, 10);
      var s2 = parseInt(seEl.value, 10);
      if (isNaN(s1) || isNaN(s2)) { statutEl.value = ''; return; }
      if (s1 === s2) { statutEl.value = 'Match Nul'; return; }
      var n1 = teamNameFromLabel(labelDom).toLowerCase();
      var n2 = teamNameFromLabel(labelExt).toLowerCase();
      var isClub1 = CLUBS.some(function(a){ return n1.indexOf(a) !== -1; });
      var isClub2 = CLUBS.some(function(a){ return n2.indexOf(a) !== -1; });
      if (s1 > s2) {
        if (isClub1) statutEl.value = 'Victoire';
        else if (isClub2) statutEl.value = 'Défaite';
        else statutEl.value = 'Terminé';
      } else {
        if (isClub2) statutEl.value = 'Victoire';
        else if (isClub1) statutEl.value = 'Défaite';
        else statutEl.value = 'Terminé';
      }
    }
    if (sdEl && seEl) {
      sdEl.addEventListener('input', compute);
      seEl.addEventListener('input', compute);
    }
    // recalcul au submit par sécurité
    var form = document.getElementById('f');
    if (form) form.addEventListener('submit', compute);
    // recalcul quand on revient à une autre rencontre
    var changeBtn = document.getElementById('changeBtn');
    if (changeBtn) changeBtn.addEventListener('click', function(){ statutEl.value=''; });
  })();
</script>
</body>
</html>
